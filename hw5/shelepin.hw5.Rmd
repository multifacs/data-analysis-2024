# Домашнее задание 5

Описание данных. В пакете openintro содержится набор данных bdims. Это морфометрические данные 507 физически активных людей. Набор содержит 25 переменных, расшифровку имен переменных можно найти на странице справки, которую можно открыть с помощью команды помощи ?bdims.

1. Загрузите пакет openintro.

```{r packages}
# install.packages("pacman")
pacman::p_load(openintro, boot, dplyr)
```

2. Активируйте набор данных bdims.

```{r}
# Загрузка данных bdims
data(bdims)

# Посмотрим на структуру данных
str(bdims)
```


3. Выберите в новый фрейм данные по женщинам старше 26 лет. Все дальнейшие манипуляции проводите с данными из этого фрейма.

```{r}
# Фильтрация данных: женщины (sex == 0) и возраст > 26
women_over_26 <- bdims %>%
  filter(sex == 0, age > 26)

# Посмотрим на новый фрейм
head(women_over_26)
```

4. Напишите функцию proc10(), принимающую вектор значений и индексирующий вектор, которая рассчитывает 10-й процентиль.

```{r}
proc10 <- function(values) {
  # Рассчитываем 10-й процентиль
  percentile_10 <- quantile(values, probs = 0.1, na.rm = TRUE)
  
  # Возвращаем результат
  return(percentile_10)
}
```

5. Используйте функцию proc10() для расчета 10-го процентиля окружности груди.

```{r}
# Рассчитаем 10-й процентиль окружности груди (che_di)
percentile_10_che_di <- proc10(women_over_26$che_di)

# Вывод результата
percentile_10_che_di
```


6. Постройте бутстреп-распределение значений 10-го процентиля окружности груди на основе 7000 псевдовыборок с помощью функции boot.

```{r}
# Функция для вычисления 10-го процентиля
boot_proc10 <- function(data, indices) {
  # Выбираем данные по индексам
  sample_data <- data[indices]
  
  # Рассчитываем 10-й процентиль
  return(quantile(sample_data, probs = 0.1, na.rm = TRUE))
}

# Применяем boot для построения бутстреп-распределения
set.seed(123)  # Устанавливаем зерно для воспроизводимости
boot_results <- boot(
  data = women_over_26$che_di,  # Данные (окружность груди)
  statistic = boot_proc10,     # Наша функция для расчёта 10-го процентиля
  R = 7000                     # Количество псевдовыборок
)

# Выводим результаты бутстрепа
print(boot_results)
```

7. Постройте гистограмму бутстреп-распределения значений 10-го процентиля окружности груди таким образом, чтобы число интервалов было не менее 35.

```{r}
# Построим гистограмму с числом интервалов не менее 35
hist(
  boot_results$t,  # Бутстреп-результаты
  breaks = 35,     # Количество интервалов
  main = "Бутстреп-распределение 10-го процентиля окружности груди",
  xlab = "10-й процентиль",
  col = "lightblue",  # Цвет столбцов
  border = "white"    # Цвет границ столбцов
)

# Добавим вертикальную линию для среднего значения
abline(v = mean(boot_results$t), col = "red", lwd = 2)
```

8. Рассчитайте доверительный интервал для 10-го процентиля окружности груди на основе бутстреп-распределения методом процентилей. Отобразите итервал на гистограмме в виде двух вертикальных линий (возпользуйтесь функцией abline).

```{r}
# Рассчитываем доверительный интервал методом процентилей
ci <- boot.ci(boot_results, type = "perc")

# Извлекаем границы доверительного интервала
lower_bound <- ci$percent[4]  # Нижняя граница
upper_bound <- ci$percent[5]  # Верхняя граница

# Построим гистограмму бутстреп-распределения
hist(
  boot_results$t,  # Бутстрепные значения
  breaks = 35,     # Количество интервалов
  main = "Бутстреп-распределение 10-го процентиля окружности груди",
  xlab = "10-й процентиль", 
  col = "lightblue",
  border = "white"
)

# Добавляем вертикальную линию для среднего значения
abline(v = mean(boot_results$t), col = "red", lwd = 2, lty = 1)  # Среднее значение

# Добавляем вертикальные линии для границ доверительного интервала
abline(v = lower_bound, col = "darkgreen", lwd = 2, lty = 2)  # Нижняя граница
abline(v = upper_bound, col = "darkgreen", lwd = 2, lty = 2)  # Верхняя граница
```

```{r}
cat("Доверительный интервал (метод процентилей):\n")
cat("Нижняя граница:", lower_bound, "\n")
cat("Верхняя граница:", upper_bound, "\n")
```

9. Постройте график зависимости окружности плеча от диаметра лодыжки. Используйте залитые полупрозрачные квадраты красного цвета. Подпишите оси. Добавьте на график линию регрессии.

```{r}
# Построим график зависимости окружности плеча (humerus) от диаметра лодыжки (ankle)
plot(
  women_over_26$sho_gi ~ women_over_26$ank_di,  # Зависимость переменных
  col = rgb(1, 0, 0, 0.5),  # Полупрозрачный красный цвет (R,G,B,alpha)
  pch = 15,                 # Тип точки (заполненные квадраты)
  main = "Зависимость окружности плеча от диаметра лодыжки", 
  xlab = "Диаметр лодыжки (ankle, см)", 
  ylab = "Окружность плеча (humerus, см)"
)

# Добавляем линию регрессии
regression_model <- lm(sho_gi ~ ank_di, data = women_over_26)  # Линейная регрессия
abline(regression_model, col = "blue", lwd = 2)  # Линия регрессии
```
```{r}
summary(regression_model)
```

10. Проведите анализ зависимости окружности плеча от диаметра лодыжки на основе перестановочной процедуры. В комментарии приведите число выполненных перестановок, полученное p-значение, а также сделайте итоговый вывод.

```{r}
# Установим количество перестановок
num_permutations <- 10000

# Рассчитаем наблюдаемую статистику F для модели линейной регрессии
observed_model <- lm(sho_gi ~ ank_di, data = women_over_26)
observed_f_stat <- summary(observed_model)$fstatistic[1]

# Функция для выполнения одной перестановки
permutation_test <- function(data, num_permutations) {
  permuted_f_stats <- numeric(num_permutations)  # Вектор для хранения F-статистик

  for (i in 1:num_permutations) {
    permuted_data <- data
    permuted_data$sho_gi <- sample(permuted_data$sho_gi)  # Перемешиваем окружность плеча

    permuted_model <- lm(sho_gi ~ ank_di, data = permuted_data)
    permuted_f_stats[i] <- summary(permuted_model)$fstatistic[1]
  }

  return(permuted_f_stats)
}

# Выполняем перестановочный тест
set.seed(123)  # Устанавливаем зерно для воспроизводимости
permuted_f_stats <- permutation_test(women_over_26, num_permutations)

# Рассчитываем p-значение
p_value <- mean(permuted_f_stats >= observed_f_stat)

# Выводим результаты
cat("Число выполненных перестановок:", num_permutations, "\n")
cat("Наблюдаемая F-статистика:", observed_f_stat, "\n")
cat("p-значение:", p_value, "\n")

# Итоговый вывод
if (p_value < 0.05) {
  cat("Итоговый вывод: Есть статистически значимая зависимость между окружностью плеча и диаметром лодыжки (p < 0.05).\n")
} else {
  cat("Итоговый вывод: Нет статистически значимой зависимости между окружностью плеча и диаметром лодыжки (p >= 0.05).\n")
}
```

