```{r}
if (require(pacman)) {
  install.packages("pacman")
}

pacman::p_load(ISwR, ggplot2, dplyr, nortest, car, tidyverse, scales, emmeans, multcomp, multcompView, gtsummary, knitr)
```


#---------------------------#
# # # # # Задание 1 # # # # #
#---------------------------#

# Polis et al. (1998) изучали распределение ящериц по островам Калифорнийского 
# залива. Для 19 островов измерено отношение периметра к площади (ratio), 
# а также собраны сведения о присутствии/отсутствии ящериц рода Uta 
# (переменная pa: 0 - есть, 1 - нет).

```{r}
polis <- read.csv("polis.csv")
```


# Постройте модель зависимости вероятности присутствия ящериц от отношения 
# периметра острова к его площади

```{r}
model <- glm(pa ~ ratio, data=polis, family=binomial)
summary(model)
```

# Значимо ли влияние отношения периметра к площади на присутствие ящериц?

p-value = 0.02 < 0.05 -- влияние значимо


# Рассчитайте отношение периметра к площади, при котором вероятность 
# присутствия ящериц составляет ровно 0.5

Для логистической регрессии в форме:
[ \text{logit}(p) = \log\left(\frac{p}{1-p}\right) = \beta_0 + \beta_1 \times \text{ratio} ]

где ( p ) это вероятность присутствия ящериц (то есть ( pa = 1 )), нам нужно найти значение ratio, при котором ( p = 0.5 ).

При ( p = 0.5 ), отношение ( \frac{p}{1-p} = 1 ), поэтому:
[ \log\left(\frac{0.5}{1-0.5}\right) = \log(1) = 0 ]

Тогда из уравнения логита:
[ \beta_0 + \beta_1 \times \text{ratio} = 0 ]

Отсюда можно выразить ratio:
[ \text{ratio} = -\frac{\beta_0}{\beta_1} ]

Чтобы найти ( \beta_0 ) и ( \beta_1 ), вам нужно взглянуть на вывод функции summary(model). В этом выводе вы найдёте оценки коэффициентов (Estimate) для перехвата (Intercept) и для ratio.

Предположим, что в результате summary(model) были получены следующие коэффициенты:

Intercept (или ( \beta_0 )): 1.20
ratio (или ( \beta_1 )): -2.50
Тогда:
[ \text{ratio} = -\frac{1.20}{-2.50} = \frac{1.20}{2.50} = 0.48 ]

Таким образом, при ratio = 0.48 вероятность присутствия ящериц ( p ) будет ровно 0.5.

Для рассчитанной модели логистической регрессии:
\[ \text{logit}(p) = \log\left(\frac{p}{1-p}\right) = \beta_0 + \beta_1 \times \text{ratio} \]
у нас есть следующие оценки коэффициентов:
- \( \beta_0 = 3.6061 \)
- \( \beta_1 = -0.2196 \)

Нам нужно найти значение `ratio` при котором вероятность \( p = 0.5 \).

Как мы обсуждали, при \( p = 0.5 \):
\[ \log\left(\frac{p}{1-p}\right) = 0 \]
Таким образом, уравнение логита сокращается до:
\[ \beta_0 + \beta_1 \times \text{ratio} = 0 \]

Откуда:
\[ \text{ratio} = -\frac{\beta_0}{\beta_1} \]

Подставим значения:
\[ \text{ratio} = -\frac{3.6061}{-0.2196} = \frac{3.6061}{0.2196} \]

Рассчитаем:
\[ \text{ratio} = 16.4238 \]

Таким образом, при `ratio` = 16.4238 вероятность присутствия ящериц \( p \) будет ровно 0.5.

```{r}
model$coefficients
```
```{r}
ab <- coef(model)
req_ratio = -ab[1] / ab[2]
req_ratio
```
# Рассчитайте отношение периметра к площади, при котором вероятность 
# присутствия ящериц составляет ровно 0.5

# Какова вероятность присутствия ящериц на островах с отношением
# периметра к площади 10 и 50?

Для вычисления вероятности присутствия ящериц (pa = 1) на основе заданного отношения периметра к площади (ratio), мы используем логистическую функцию:
[ p = \frac{1}{1 + e^{-(\beta_0 + \beta_1 \times \text{ratio})}} ]

Из предыдущих вычислений мы знаем:

( \beta_0 = 3.6061 )
( \beta_1 = -0.2196 )
Теперь мы подставим значение ratio равное 10 и 50, чтобы найти вероятности.

1. Для ratio = 10:

[ p = \frac{1}{1 + e^{-(3.6061 + (-0.2196) \times 10)}} ]
[ p = \frac{1}{1 + e^{-(3.6061 - 2.196)}} ]
[ p = \frac{1}{1 + e^{-(1.4101)}} ]

Рассчитаем:
[ p = \frac{1}{1 + e^{-1.4101}} ]
[ p = \frac{1}{1 + 0.2441} ]
[ p = \frac{1}{1.2441} ]
[ p \approx 0.8039 ]

2. Для ratio = 50:

[ p = \frac{1}{1 + e^{-(3.6061 + (-0.2196) \times 50)}} ]
[ p = \frac{1}{1 + e^{-(3.6061 - 10.98)}} ]
[ p = \frac{1}{1 + e^{-(3.6061 - 10.98)}} ]
[ p = \frac{1}{1 + e^{7.3739}} ]

Рассчитаем:
[ p = \frac{1}{1 + e^{7.3739}} ]
[ p = \frac{1}{1 + 1591.5494} ]
[ p = \frac{1}{1592.5494} ]
[ p \approx 0.000628 ]

Итак, вероятности присутствия ящериц:

При ratio = 10: ( p \approx 0.804 )
При ratio = 50: ( p \approx 0.00063 )
Эти результаты показывают, что на островах с меньшим отношением периметра к площади вероятность обнаружения ящериц значительно выше.

```{r}
ratios = c(10, 50)

exp(ab[1] + ab[2] * ratios) / (1 + exp(ab[1] + ab[2] * ratios))
```


# Создайте и оформите диаграмму рассеяния, добавьте на нее линию логистическую
# кривую. Отдельные наблюдения следует отобразить залитыми кругами 
# серого цвета. Линия регрессии должна иметь двойную толщину.

```{r}
new <- data.frame(ratio = seq(min(polis$ratio), max(polis$ratio), length=100))
                  
pr <- predict(model, new, type = "response")

plot(pa ~ ratio, polis, col = "gray", pch = 16, 
     xlab = "Отношение периметра к площади (ratio)", 
     ylab = "Вероятность присутствия ящериц (pa)", 
     main = "Диаграмма рассеяния с логистической регрессией")

lines(new$ratio, pr, lwd = 2)
```


# Дайте интервальную оценку коэффициентов логистической регрессии

```{r}
confint(model)
```


# Воспользуйтесь функцией predict() для расчета доверительных интервалов 
# для положения линии регрессии


# Постройте итоговый график: диаграмма рассеяния с логистической кривой и 
# доверительными интервалами для среднего прогноза. Логистическая кривая и 
# доверительные интервалы должны отличаться типом линии и цветом

```{r}
pred_logit <- predict(model, new, type = "link", se = TRUE)

logit_lwr <- pred_logit$fit - 1.96 * pred_logit$se.fit
logit_upr <- pred_logit$fit + 1.96 * pred_logit$se.fit

pr <- 1 / (1 + exp(-pred_logit$fit))
pr_lwr <- 1 / (1 + exp(-logit_lwr))
pr_upr <- 1 / (1 + exp(-logit_upr))

new$predicted <- pr
new$lwr <- pr_lwr
new$upr <- pr_upr

plot(pa ~ ratio, polis, col = "gray", pch = 16, 
     xlab = "Отношение периметра к площади (ratio)", 
     ylab = "Вероятность присутствия ящериц (pa)",
     main = "Диаграмма с доверительными интервалами")

lines(new$ratio, new$predicted, lwd = 2)
matlines(new$ratio, cbind(new$lwr, new$upr), lty = 1, col = c("red", "blue"), lwd = 1)
legend("bottomleft", legend = c("Predicted", "Lower 95%", "Upper 95%"),
       col = c("black", "red", "blue"), lty = 1, lwd = 2, cex = 0.8)
```

```{r}
pr <- predict(model, new, type = "link", se = TRUE)

plot(pa ~ ratio, polis)

lines(new$ratio, exp(pr$fit) / (1 + exp(pr$fit)))

upr <- pr$fit + pr$se.fit * qnorm(1 - 0.05 / 2)
lwr <- pr$fit - pr$se.fit * qnorm(1 - 0.05 / 2)

lines(new$ratio, exp(upr) / (1 + exp(upr)))
lines(new$ratio, exp(lwr) / (1 + exp(lwr)))
```


#---------------------------#
# # # # # Задание 2 # # # # #
#---------------------------#

# Gotelli and Ellison (2001) изучали факторы, влияющие на видовое богатство
# муравьев в Новой Англии. На 44 участках определено число видов 
# муравьев (Srich), а также сохранены данные о широте (Latitude) и высоте
# над уровнем моря (Elevation)

```{r}
got <- read.csv("gotelli.csv")
```


# Постройте график зависимости видового богатства от широты

```{r}
plot(Srich ~ Latitude, got)
```


# Постройте модель зависимости видового богатства от широты

```{r}
model <- glm(Srich ~ Latitude, data=got, family=poisson)
summary(model)
```

# Значимо ли влияние широты?

p-value < 0.05 -- влияние значимо

# Сделайте прогноз числа видов муравьев на участках, которые находятся 
# в окрестностях Нью-Йорка, Бостона и Монреаля

Для выполнения прогноза числа видов муравьев на участках в окрестностях Нью-Йорка, Бостона и Монреаля, нам сначала нужно определить широты для этих городов:

Нью-Йорк: Широта приблизительно 40.71° N
Бостон: Широта приблизительно 42.36° N
Монреаль: Широта приблизительно 45.51° N

```{r}
# Создаем датафрейм с широтами Нью-Йорка, Бостона и Монреаля
new_locations <- data.frame(Latitude = c(40.71, 42.36, 45.51))

# Прогнозирование числа видов муравьев на новых локациях
predictions <- predict(model, newdata = new_locations, type = "response")

# Создаем имена для вывода результатов
location_names <- c("New York", "Boston", "Montreal")

# Выводим прогнозы с названиями локаций
data.frame(Location = location_names, Predicted_Srich = predictions)
```


# Воспользуйтесь функцией predict() для расчета доверительных интервалов 
# для положения линии регрессии
# Постройте итоговый график: диаграмма рассеяния с кривой пуассоновской 
# регрессии и доверительными интервалами для среднего прогноза. Кривая 
# регрессии и доверительные интервалы должны отличаться типом линии и цветом

```{r}
# Последовательность широт для прогнозирования и построения интервалов
latitude_seq <- seq(from = min(got$Latitude), to = max(got$Latitude), length.out = 100)
new_data <- data.frame(Latitude = latitude_seq)

# Расчет предсказаний и их стандартных ошибок
pred <- predict(model, newdata = new_data, type = "link", se.fit = TRUE)

# Логарифм среднего ответа и его стандартные ошибки
link_est <- pred$fit
link_se <- pred$se.fit

# Расчет доверительных интервалов на логарифмической шкале
alpha <- 0.05
z <- qnorm(1 - alpha / 2)
link_lwr <- link_est - z * link_se
link_upr <- link_est + z * link_se

# Преобразование интервалов в оригинальный масштаб ответа
est <- exp(link_est)
lwr <- exp(link_lwr)
upr <- exp(link_upr)

# Построение графика с доверительными интервалами
plot(got$Latitude, got$Srich, 
     xlab = "Latitude", 
     ylab = "Species richness (Srich)", 
     main = "Species Richness vs. Latitude with Confidence Intervals")

# Добавление линии регрессии
lines(new_data$Latitude, est, col = "blue", lwd = 2)

# Добавление доверительных интервалов
matlines(new_data$Latitude, cbind(lwr, upr), col = c("red", "red"), lty = 2, lwd = 1)

# Легенда для графика
legend("topright", legend = c("Predicted", "95% CI"), col = c("blue", "red"), lty = c(1, 2), cex = 0.8)
```

